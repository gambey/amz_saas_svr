# 405 Not Allowed 错误修复指南

## 问题分析

你遇到的 **405 Not Allowed** 错误通常是由以下原因引起的：

1. **Nginx 反向代理配置问题**（最常见）
   - Nginx 没有正确转发 POST 请求
   - 缺少必要的代理头设置

2. **CORS 配置缺少 www 子域名**
   - 你访问的是 `www.bestswitch2dock.xyz`，但 CORS 可能只配置了 `bestswitch2dock.xyz`

## 快速修复步骤

### 步骤 1: 更新服务器上的 .env 文件（包含 www 子域名）

SSH 登录服务器：

```bash
cd /opt/amz-saas
nano .env
```

确保 `ALLOWED_ORIGINS` 包含 `www` 子域名：

```env
ALLOWED_ORIGINS=http://bestswitch2dock.xyz,https://bestswitch2dock.xyz,http://www.bestswitch2dock.xyz,https://www.bestswitch2dock.xyz
```

保存后重启应用：

```bash
docker-compose restart app
```

### 步骤 2: 修复 Nginx 配置（重要！）

这是最可能的原因。编辑 Nginx 配置：

```bash
sudo nano /etc/nginx/sites-available/bestswitch2dock.xyz
```

**关键配置（必须包含）：**

```nginx
server {
    listen 80;
    server_name bestswitch2dock.xyz www.bestswitch2dock.xyz;

    # API 反向代理
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        
        # 重要：这些请求头必须设置
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 允许请求体（POST 请求必需）
        proxy_request_buffering off;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

**完整配置示例（如果还有前端静态文件）：**

```nginx
server {
    listen 80;
    server_name bestswitch2dock.xyz www.bestswitch2dock.xyz;

    # 前端静态文件
    location / {
        root /var/www/html;
        try_files $uri $uri/ /index.html;
    }

    # API 反向代理
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_request_buffering off;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

测试并重启 Nginx：

```bash
# 测试配置
sudo nginx -t

# 如果测试通过，重启
sudo systemctl restart nginx
```

### 步骤 3: 验证修复

在浏览器控制台或使用 curl 测试：

```bash
curl -X POST http://www.bestswitch2dock.xyz/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

应该返回 JSON 响应，而不是 405 错误。

## 如果问题仍然存在

### 检查 1: 确认应用正在运行

```bash
cd /opt/amz-saas
docker-compose ps
docker-compose logs app --tail=50
```

### 检查 2: 直接测试后端（绕过 Nginx）

在服务器上执行：

```bash
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

- 如果这个可以工作，说明是 Nginx 配置问题
- 如果这个也不行，说明是应用配置问题

### 检查 3: 查看 Nginx 错误日志

```bash
sudo tail -f /var/log/nginx/error.log
```

在浏览器中再次尝试登录，查看日志中的错误信息。

### 检查 4: 确认端口映射

检查 docker-compose.yml 中的端口映射：

```bash
cd /opt/amz-saas
cat docker-compose.yml | grep ports
```

应该看到：
```yaml
ports:
  - "3000:3000"
```

## 常见错误配置对比

### ❌ 错误配置（会导致 405）

```nginx
location /api {
    proxy_pass http://localhost:3000;
    # 缺少必要的请求头
}
```

### ✅ 正确配置

```nginx
location /api {
    proxy_pass http://localhost:3000;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_request_buffering off;
}
```

## 详细配置文档

更多 Nginx 配置选项，请查看 [NGINX_CONFIG.md](./NGINX_CONFIG.md)
